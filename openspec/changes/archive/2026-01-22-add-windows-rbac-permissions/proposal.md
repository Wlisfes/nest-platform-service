## Why

web-windows-server 当前具备基础认证（JWT 解析）与数据库表结构（菜单/按钮/接口/角色/部门），但缺少完整的 RBAC 授权体系与对应的管理接口。现状如下：

-   **认证**：`AuthWindowsGuard` 仅做 JWT 解析并挂载 `request.user`，无权限校验
-   **资源管理**：
    -   菜单资源 CRUD 基本实现，但 `switch/delete` 与 `sheet` 相关接口未完成
    -   按钮（`resource_sheet`）与接口（`resource_apifox`）的 CRUD 与状态管理接口缺失
-   **角色管理**：`RoleController` 与 `RoleService` 为空，无角色 CRUD 与授权接口
-   **部门管理**：`DeptController` 与 `DeptService` 为空，无组织树管理接口
-   **权限关联**：仅 `tb_windows_role_resource`（菜单）关联表，缺少按钮与接口的关联表

为支撑企业级后台的权限管控，需补齐：

-   菜单/按钮/接口的完整管理接口（新增/编辑/状态变更/删除/树/列表）
-   角色与部门的 CRUD 接口
-   角色授权接口（分别勾选菜单/按钮/API）
-   RBAC 校验机制（从 JWT → 角色 → 权限 → 拦截）

## What Changes

本次 change 将在 web-windows-server 补齐一套完整的 RBAC 权限体系，包含以下能力：

### 1. 资源管理（菜单/按钮/接口）

-   菜单资源：新增/编辑/详情/树结构/列表/状态变更/删除
-   按钮资源：新增/编辑/详情/列表/状态变更/删除（归属菜单）
-   接口资源：新增/编辑/详情/列表/状态变更/删除（归属菜单）

### 2. 角色管理

-   角色基础 CRUD（名称/描述/排序/数据权限模型）
-   角色授权接口：分别勾选菜单/按钮/API 并写入对应关联表
-   角色关联账号（可选，视需求）

### 3. 部门管理

-   部门组织树 CRUD（名称/别名/上级部门）
-   部门关联账号（可选，视需求）

### 4. RBAC 授权机制

-   扩展 `AuthWindowsGuard`：在 JWT 解析后查询用户角色与权限，并拦截未授权请求
-   提供装饰器或反射器机制，用于声明接口所需的权限 key
-   权限缓存策略（Redis），避免每次请求都查库

### 5. 数据库补齐

-   新增 `tb_windows_role_sheet`（角色-按钮关联表）
-   新增 `tb_windows_role_apifox`（角色-接口关联表）
-   必要索引与外键约束

## Impact

-   **业务影响**：后台系统将具备完整的权限管控能力，可按角色精细控制菜单、按钮、接口访问
-   **技术影响**：
    -   `AuthWindowsGuard` 将承担 RBAC 校验职责，需保证性能与可测试性
    -   新增接口需统一错误处理与日志记录
    -   数据库表变更需考虑迁移脚本
-   **安全影响**：所有受控接口将受权限校验保护，降低越权风险

## Dependencies

-   依赖现有数据库表结构（`tb_windows_*` 系列）
-   依赖现有 JWT 与 Redis 基础设施
-   依赖现有 `DataBaseService` 与事务机制

## Risks / Mitigations

-   **风险**：RBAC 校验逻辑复杂，可能影响接口性能  
    **缓解**：引入 Redis 缓存用户权限，设置合理 TTL；在 Guard 中做批量权限查询
-   **风险**：角色授权接口并发写入可能导致数据不一致  
    **缓解**：使用数据库事务，确保三张关联表原子性写入
-   **风险**：菜单/按钮/接口的删除级联逻辑复杂  
    **缓解**：明确删除策略（硬删除/软删除），并在 service 层做级联清理

## Success Criteria

-   所有新增接口通过单元测试与集成测试
-   RBAC 校验覆盖所有受控路由，未授权请求被正确拦截
-   权限缓存命中率达到 95% 以上，接口响应时间不显著增加
-   角色授权接口可正确写入三张关联表，并支持回滚
