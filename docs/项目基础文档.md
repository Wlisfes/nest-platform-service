# 开发指南

## 项目结构

```
nest-platform-service/
├── src/                    # 源代码目录
│   ├── common/             # 公共模块
│   │   ├── decorators/     # 装饰器
│   │   ├── filters/        # 异常过滤器
│   │   ├── guards/         # 守卫
│   │   ├── interceptors/   # 拦截器
│   │   └── middleware/     # 中间件
│   │
│   ├── modules/            # 业务模块
│   │   ├── auth/           # 认证授权模块
│   │   ├── user/           # 用户管理
│   │   ├── role/           # 角色管理
│   │   └── menu/           # 菜单管理
│   │
│   ├── config/             # 配置文件
│   ├── database/           # 数据库相关
│   │   ├── migrations/     # 数据库迁移
│   │   └── seeders/        # 数据填充
│   └── main.ts             # 应用入口
│
├── test/                   # 测试目录
│   ├── e2e/                # 端到端测试
│   └── unit/               # 单元测试
│
├── .env                    # 环境变量
├── .env.example            # 环境变量示例
├── .eslintrc.js            # ESLint 配置
├── .prettierrc             # Prettier 配置
├── nest-cli.json           # NestJS 配置
├── package.json            # 项目依赖
├── tsconfig.json           # TypeScript 配置
└── README.md               # 项目说明
```

## 环境要求

-   Node.js: ^18.0.0
-   npm: ^9.0.0 或 yarn: ^1.22.0
-   MySQL: ^8.0.0
-   Redis: ^6.0.0
-   Docker: ^20.10.0 (可选，用于容器化部署)

## 安装依赖

```bash
# 安装项目依赖
$ npm install
# 或
$ yarn install

# 安装开发依赖
$ npm install -D @types/node @types/express @types/supertest
```

## 配置文件

### 环境变量配置 (`.env`)

复制 `.env.example` 并重命名为 `.env`，然后修改相应配置：

```env
# 应用配置
NODE_ENV=development
PORT=3000
APP_SECRET=your_app_secret

# 数据库配置
DB_HOST=localhost
DB_PORT=3306
DB_USERNAME=root
DB_PASSWORD=your_password
DB_DATABASE=nest_platform

# Redis 配置
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=

# JWT 配置
JWT_SECRET=your_jwt_secret
JWT_EXPIRES_IN=3600

# 文件存储 (阿里云 OSS)
OSS_REGION=oss-cn-hangzhou
OSS_ACCESS_KEY_ID=your_access_key_id
OSS_ACCESS_KEY_SECRET=your_access_key_secret
OSS_BUCKET=your_bucket_name
```

## 开发命令

```bash
# 开发模式 (带热重载)
$ npm run start:dev

# 生产模式
$ npm run start:prod

# 运行测试
$ npm run test

# 运行 e2e 测试
$ npm run test:e2e

# 代码格式化
$ npm run format

# 代码检查
$ npm run lint

# 数据库迁移
$ npm run migration:generate --name=MigrationName
$ npm run migration:run
$ npm run migration:revert

# 构建项目
$ npm run build
```

## 依赖管理

### 主要依赖

| 依赖              | 版本    | 用途                    |
| ----------------- | ------- | ----------------------- |
| @nestjs/common    | ^10.0.0 | NestJS 核心模块         |
| @nestjs/core      | ^10.0.0 | NestJS 核心功能         |
| @nestjs/jwt       | ^10.0.0 | JWT 认证                |
| @nestjs/passport  | ^10.0.0 | 认证中间件              |
| @nestjs/swagger   | ^7.0.0  | API 文档                |
| typeorm           | ^0.3.0  | ORM 框架                |
| mysql2            | ^3.0.0  | MySQL 驱动              |
| redis             | ^4.0.0  | Redis 客户端            |
| ioredis           | ^5.0.0  | Redis 客户端 (替代方案) |
| class-validator   | ^0.14.0 | 请求参数验证            |
| class-transformer | ^0.5.0  | 对象转换                |

### 开发依赖

| 依赖               | 版本    | 用途              |
| ------------------ | ------- | ----------------- |
| @nestjs/cli        | ^10.0.0 | NestJS 命令行工具 |
| @nestjs/schematics | ^10.0.0 | NestJS 代码生成   |
| @types/node        | ^18.0.0 | Node.js 类型定义  |
| typescript         | ^5.0.0  | TypeScript 编译器 |
| eslint             | ^8.0.0  | 代码检查          |
| prettier           | ^3.0.0  | 代码格式化        |
| jest               | ^29.0.0 | 测试框架          |
| supertest          | ^6.0.0  | HTTP 测试         |
| husky              | ^8.0.0  | Git 钩子          |
| lint-staged        | ^13.0.0 | 提交前检查        |

## 代码提交规范

提交信息格式：`<type>(<scope>): <subject>`

### 类型 (type)

-   `feat`: 新功能
-   `fix`: 修复 bug
-   `docs`: 文档更新
-   `style`: 代码格式调整
-   `refactor`: 代码重构
-   `perf`: 性能优化
-   `test`: 测试相关
-   `chore`: 构建过程或辅助工具的变动

### 示例

```
feat(auth): 新增 JWT 认证功能
fix(user): 修复用户注册时的验证问题
docs: 更新 README 文档
style: 格式化代码
```

## 部署指南

### 开发环境

1. 安装依赖：`npm install`
2. 配置 `.env` 文件
3. 启动服务：`npm run start:dev`

### 生产环境

使用 Docker 部署：

```bash
# 构建镜像
$ docker build -t nest-platform .

# 运行容器
$ docker run -p 3000:3000 --env-file .env nest-platform
```

## 常见问题

1. **数据库连接失败**

    - 检查数据库服务是否运行
    - 验证 `.env` 中的数据库配置
    - 检查数据库用户权限

2. **端口冲突**

    - 修改 `.env` 中的 `PORT` 配置
    - 检查是否有其他服务占用了相同端口

3. **依赖安装问题**
    - 清除缓存：`npm cache clean --force`
    - 删除 `node_modules` 和 `package-lock.json` 后重新安装

## 贡献指南

1. Fork 项目
2. 创建特性分支 (`git checkout -b feature/AmazingFeature`)
3. 提交更改 (`git commit -m 'Add some AmazingFeature'`)
4. 推送到分支 (`git push origin feature/AmazingFeature`)
5. 发起 Pull Request
