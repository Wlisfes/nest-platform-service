# 项目源代码结构说明

## 目录概览

```
src/
├── common/             # 公共模块
│   ├── constants/     # 常量定义
│   ├── decorators/    # 自定义装饰器
│   ├── exceptions/    # 异常处理
│   ├── filters/       # 异常过滤器
│   ├── guards/        # 守卫
│   ├── interceptors/  # 拦截器
│   ├── interfaces/    # 接口定义
│   ├── middleware/    # 中间件
│   └── utils/         # 工具函数
│
├── config/            # 配置模块
│   ├── config.module.ts
│   ├── config.service.ts
│   ├── database.config.ts
│   └── swagger.config.ts
│
├── database/          # 数据库相关
│   ├── migrations/    # 数据库迁移文件
│   ├── seeders/       # 数据填充
│   └── database.module.ts
│
├── modules/           # 业务模块
│   ├── auth/          # 认证授权模块
│   ├── user/          # 用户管理
│   ├── role/          # 角色管理
│   └── menu/          # 菜单管理
│
├── app.module.ts      # 根模块
└── main.ts           # 应用入口文件
```

## 1. 公共模块 (common/)

### 1.1 常量 (constants/)

-   `app.constants.ts`: 应用级常量
-   `error-codes.constants.ts`: 错误码定义
-   `regex.constants.ts`: 正则表达式常量

### 1.2 装饰器 (decorators/)

-   `auth.decorator.ts`: 认证装饰器
    -   `@Public()`: 标记为公开接口
    -   `@Roles()`: 角色权限控制
-   `current-user.decorator.ts`: 获取当前用户
-   `transform.decorators.ts`: 数据转换装饰器

### 1.3 异常处理 (exceptions/)

-   `business.exception.ts`: 业务异常基类
-   `http-exception.filter.ts`: HTTP 异常过滤器
-   `validation-exception.ts`: 参数验证异常

### 1.4 守卫 (guards/)

-   `jwt-auth.guard.ts`: JWT 认证守卫
-   `roles.guard.ts`: 角色权限守卫
-   `throttler.guard.ts`: 请求限流守卫

### 1.5 拦截器 (interceptors/)

-   `logging.interceptor.ts`: 请求日志拦截器
-   `response.interceptor.ts`: 统一响应格式拦截器
-   `timeout.interceptor.ts`: 请求超时拦截器

### 1.6 中间件 (middleware/)

-   `logger.middleware.ts`: 请求日志中间件
-   `request-context.middleware.ts`: 请求上下文中间件

### 1.7 工具函数 (utils/)

-   `crypto.util.ts`: 加密工具
-   `date.util.ts`: 日期处理工具
-   `string.util.ts`: 字符串处理工具
-   `validator.util.ts`: 验证工具

## 2. 配置模块 (config/)

### 2.1 配置服务 (config.service.ts)

```typescript
@Injectable()
export class ConfigService {
    constructor(private configService: ConfigService) {}

    get<T>(key: string): T {
        return this.configService.get<T>(key)
    }
}
```

### 2.2 数据库配置 (database.config.ts)

```typescript
export default registerAs('database', () => ({
    host: process.env.DB_HOST,
    port: parseInt(process.env.DB_PORT, 10) || 3306,
    username: process.env.DB_USERNAME,
    password: process.env.DB_PASSWORD,
    database: process.env.DB_DATABASE
}))
```

### 2.3 Swagger 配置 (swagger.config.ts)

```typescript
export const swaggerConfig = new DocumentBuilder()
    .setTitle('Nest Platform API')
    .setDescription('Nest 平台接口文档')
    .setVersion('1.0')
    .addBearerAuth()
    .build()
```

## 3. 数据库模块 (database/)

### 3.1 数据库迁移 (migrations/)

-   使用 TypeORM 进行数据库迁移
-   命名规范：`TIMESTAMP-Description.ts`

### 3.2 数据填充 (seeders/)

-   初始管理员账号
-   基础角色和权限
-   系统菜单数据

## 4. 业务模块 (modules/)

### 4.1 模块结构

每个业务模块应包含以下文件：

```
module-name/
├── dto/               # 数据传输对象
│   ├── create-xxx.dto.ts
│   └── update-xxx.dto.ts
├── entities/          # 数据库实体
│   └── xxx.entity.ts
├── xxx.controller.ts  # 控制器
├── xxx.service.ts     # 服务
├── xxx.module.ts      # 模块定义
└── xxx.interface.ts   # 接口定义
```

### 4.2 认证授权模块 (auth/)

-   登录/登出
-   Token 刷新
-   权限校验

### 4.3 用户模块 (user/)

-   用户 CRUD
-   用户状态管理
-   个人资料更新

### 4.4 角色模块 (role/)

-   角色管理
-   权限分配
-   角色-菜单关联

### 4.5 菜单模块 (menu/)

-   菜单管理
-   权限控制
-   动态路由生成

## 5. 最佳实践

### 5.1 控制器 (Controller)

```typescript
@Controller('users')
@ApiTags('用户管理')
@UseGuards(JwtAuthGuard)
export class UserController {
    constructor(private readonly userService: UserService) {}

    @Get()
    @ApiOperation({ summary: '获取用户列表' })
    async findAll(@Query() query: UserQueryDto) {
        return this.userService.findAll(query)
    }
}
```

### 5.2 服务 (Service)

```typescript
@Injectable()
export class UserService {
    constructor(
        @InjectRepository(User)
        private userRepository: Repository<User>
    ) {}

    async findAll(query: UserQueryDto) {
        const { page = 1, pageSize = 10 } = query
        const [items, total] = await this.userRepository.findAndCount({
            skip: (page - 1) * pageSize,
            take: pageSize
        })
        return { items, total }
    }
}
```

### 5.3 数据验证 (DTO)

```typescript
export class CreateUserDto {
    @ApiProperty({ description: '用户名' })
    @IsString()
    @IsNotEmpty()
    @MinLength(4)
    @MaxLength(20)
    username: string

    @ApiProperty({ description: '密码' })
    @IsString()
    @IsNotEmpty()
    @MinLength(6)
    @MaxLength(20)
    @Matches(/(?=.*[a-z])(?=.*[A-Z])(?=.*\d)[^]{6,}$/, {
        message: '密码必须包含大小写字母和数字'
    })
    password: string
}
```

## 6. 开发规范

1. **命名规范**

    - 文件名：小写字母，短横线分隔 (kebab-case)
    - 类名：大驼峰 (PascalCase)
    - 变量/函数：小驼峰 (camelCase)
    - 常量：全大写下划线分隔 (UPPER_SNAKE_CASE)

2. **代码组织**

    - 每个类/接口一个文件
    - 相关功能组织在同一目录下
    - 避免循环依赖

3. **测试规范**
    - 测试文件与被测文件同名，后缀为 `.spec.ts`
    - 测试描述使用 `describe` 和 `it`
    - 覆盖率要求：核心业务逻辑 >= 80%
